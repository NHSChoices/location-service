<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Address Input</title>
    
    <link rel="stylesheet" type="text/css" href="assets/styles/styles.css"/>
    
    <script src="assets/scripts/knockout-3.3.0.js"></script>
    <script src="assets/scripts/jquery-1.11.3.min.js"></script>
</head>
<body>
<div id="addressEntry">
    <p>Subscription Key for Azure</p>
    <input id="subscriptionKey" type="text" data-bind="value: subscriptionKey"/>
    <hr/>
    <p>Search for address</p>
    <input id="tbAddressSearch" type="text" data-bind="textInput: inputValue"/>
</div>
<div id="addressOptions">
    <ul data-bind="foreach: addresses, visible: addresses().length > 0">
        <li>
            <span data-bind="text: description"></span>
        </li>
    </ul>
</div>
<div id="addressSelected">
    
</div>
</body>
</html>


<script type="text/javascript">
    var baseUrl = "http://locationservicesstaging.azure-api.net";
    var contentType = "application/json; charset=utf-8";

    function Address(data) {
        //this.id = ko.observable(data.Id);
        this.description = ko.observable(data.Description);
        this.count = ko.observable(data.Count);
    }

    var AddressViewModel = function () {
        var self = this;
        self.subscriptionKey = ko.observable("");
        self.inputValue = ko.observable("ct1");
        self.selectedValue = ko.observable("");
        self.addresses = ko.observableArray([]);

        self.inputValue.subscribe(function (changedValue) {
            GetAddresses(changedValue, self.addresses, self.subscriptionKey());
        });
    }

    function UpdateAddresses(data, listToUpdate) {
        var addressesReturned = data;
        listToUpdate.removeAll();

        ko.utils.arrayForEach(addressesReturned, function (item) {
            listToUpdate.push(item);
        });
    }

    function GetAddresses(searchCriteria, listToUpdate, subscriptionKey) {
        if (searchCriteria === "" || searchCriteria === null) {
            return;
        }

        $.ajax({
            contentType: contentType,
            dataType: "json",
            type: "GET",
            url: baseUrl + "/location/search/" + searchCriteria,
            headers: {
                "Ocp-Apim-Subscription-Key": subscriptionKey
            },
            success: function (data) {
                var mappedAddresses = $.map(data, function (item) { return new Address(item) });
                UpdateAddresses(mappedAddresses, listToUpdate);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("You can not send Cross Domain AJAX requests: " + errorThrown);
                return;
            }
        });
    }

    ko.applyBindings(new AddressViewModel());
</script>